# Assigning User Roles

Role assignment is handled through `ASP.NET` Identityâ€™s UserManager to ensure referential integrity and prevent direct manipulation of Identity tables.

User that have role `Admin` can assign the roles to the user. Authorization is restricted to users with the `Admin` role 
to ensure that only `privileged users can assign roles`.

## Add AssignUserRole method in IdentityController.cs

### File: IdentityController.cs
```csharp
[HttpPatch("userRole")]
    [Authorize (Roles = UserRoles.Admin) ]
    public async Task<IActionResult> AssignUserRole(AssignUserRoleCommand command)
    {
        await mediator.Send(command);
        return NoContent();
    }
```
---

## Create Command File

### File: AssignUserRoleCommand.cs

```csharp
namespace Restaurants.Application.Users.Commands.AssignUserRole;

public class AssignUserRoleCommand : IRequest
{
    public string UserEmail { get; set; }
    public string RoleName { get; set; }
   
}
```
---

## Create Command Handler File

### File: AssignUserRoleCommandHandler.cs

```csharp
namespace Restaurants.Application.Users.Commands.AssignUserRole;

public class AssignUserRoleCommandHandler(ILogger<AssignUserRoleCommandHandler> logger,
    UserManager<User> userManager,
    RoleManager<IdentityRole> roleManager) : IRequestHandler<AssignUserRoleCommand>
{
    public async Task Handle(AssignUserRoleCommand request, CancellationToken cancellationToken)
    {
        logger.LogInformation("Assigning user role: {@Request}", request);
        var user = await userManager.FindByEmailAsync(request.UserEmail)
            ?? throw new NotFoundException(nameof(User), request.UserEmail);

        var role = await roleManager.FindByNameAsync(request.RoleName)
            ?? throw new NotFoundException(nameof(IdentityRole), request.RoleName);

        await userManager.AddToRoleAsync(user, role.Name!);

    }
}
```
---

## How to test

We run the application, then we login using `user = Admin` and get the bearer token.

After that, we put the token in button `Authorize` in swagger.

Then, we open our `PATCH` Endpoint for `api/identity/userRole` and assign roles to specific user email

`Example = Assigning role owner to email "user@gmail.com"`
```yaml
{
"userEmail": "user@gmail.com",
"roleName": "Owner"
}
```


## FIXED ERROR IN THIS DOCUMENTATION (Just Noted What I Fix)

Part `NormalizedName` is important to make it become `UPPERCASE`. Because before this we seed the data
and didn't setup `NormalizedName` to `UpperCase` then our NormalizedName column is `NULL` and we get error to assigning role. 
So, we fix it using below query to add the `NormalizedName`

```sql
UPDATE "AspNetRoles" SET "NormalizedName" = UPPER("Name") WHERE "NormalizedName" IS NULL;
```

Then to avoid the similar case happen we setup the `RestaurantsSeeder.cs` to create `NormalizedName` to `Uppercase`

````csharp
List<IdentityRole> roles =
        [
            new(UserRoles.User)
            {
                NormalizedName = UserRoles.User.ToUpper()
            },
            new(UserRoles.Owner)
            {
                NormalizedName = UserRoles.Owner.ToUpper()
            },
            new(UserRoles.Admin)
            {
                NormalizedName = UserRoles.Admin.ToUpper()
            },
        ];
````


I already fix the documentation 33. Role Based Authorization to set NormalizedName to uppercase


