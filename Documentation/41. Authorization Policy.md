# Authorization Policy

Apply `Custom Authorization Requirement` documentation

**Overview**

The **Created Multiple Restaurants Policy** restricts access to specific endpoints by ensuring that a user has created a minimum number of restaurants.

### Example use case:

Allow only experienced restaurant owners to access advanced features such as viewing all restaurants.

---

## Creating a Custom Requirement

### File: Requirements/CreatedMultipleRestaurantsRequirement.cs

Defines the authorization rule by specifying the minimum number of restaurants a user must create.

```csharp
namespace Restaurants.Infrastructure.Authorization.Requirements;

public class CreatedMultipleRestaurantsRequirement(int minimumRestaurantCreated) : IAuthorizationRequirement
{
    public int MinimumRestaurantCreated { get; } = minimumRestaurantCreated;
}
```
✅ Responsibility
- Holds authorization criteria. 
- Contains no business logic. 
- Keeps policies configurable and reusable.

---

## Requirement Handler

### File: Requirements/CreatedMultipleRestaurantsRequirementHandler.cs

Validates whether the current user meets the requirement.

```csharp
namespace Restaurants.Infrastructure.Authorization.Requirements;

public class CreatedMultipleRestaurantsRequirementHandler(IRestaurantsRepository restaurantsRepository,
    IUserContext userContext
    ) : AuthorizationHandler<CreatedMultipleRestaurantsRequirement>
{
    protected override async Task HandleRequirementAsync(AuthorizationHandlerContext context, CreatedMultipleRestaurantsRequirement requirement)
    {
        var currentUser = userContext.GetCurrentUser();

        var restaurants = await restaurantsRepository.GetAllAsync();
        
        var userRestaurantCreated = restaurants.Count(r => r.OwnerId == currentUser!.Id);

        if (userRestaurantCreated >= requirement.MinimumRestaurantCreated)
        {
            context.Succeed(requirement);
        }
    }
}
```

✅ Responsibility
- Retrieves the current user. 
- Queries restaurant data. 
- Counts restaurants created by the user. 
- Grants authorization when the minimum threshold is met.

---

##  Policy Name Constant

In our Infrastructure Module, open Constant.cs file to edit

### File: Authorization/Constant.cs

Add `CreatedAtLeast2Restaurants`

```csharp
namespace Restaurants.Infrastructure.Authorization;

public static class PolicyNames
{
    public const string HasNationality = "HasNationality";
    public const string AtLeast20 = "AtLeast20";
    public const string CreatedAtLeast2Restaurants = "CreatedAtLeast2Restaurants";
}
```
✅ Why Use Constants?
- Prevents magic strings
- Enables safer refactoring
- Reduces typo-related bugs
- Improves readability

---

## Register Policy and Handler

### ServiceCollectionExtensions.cs

- Add PolicyNames
- Add service.AddScoped for CreatedMultipleRestaurantsRequirementHandler

```csharp
 services.AddAuthorizationBuilder()
            .AddPolicy(PolicyNames.HasNationality, 
                builder => builder.RequireClaim(AppClaimTypes.Nationality))
            .AddPolicy(PolicyNames.AtLeast20,
                builder => builder.AddRequirements(new MinimumAgeRequirement(20)))
            .AddPolicy(PolicyNames.CreatedAtLeast2Restaurants,
                builder => builder.AddRequirements(new CreatedMultipleRestaurantsRequirement(2)));
        
        services.AddScoped<IAuthorizationHandler,MinimumAgeRequirementHandler>();
        services.AddScoped<IAuthorizationHandler,CreatedMultipleRestaurantsRequirementHandler>();
```

✅ Why Register the Handler?

`ASP.NET` must know which handler evaluates the requirement.
Without registration, the policy will always fail.

---

## How To Test

### Protect the Endpoint

Apply the policy using the Authorize attribute in our RestaurantsController.

```csharp
 [HttpGet]
    [Authorize(Policy = PolicyNames.CreatedAtLeast2Restaurants)]
    public async Task<IActionResult> GetAll()
    {
        var restaurants = await mediator.Send(new GetAllRestaurantsQuery());
        return Ok(restaurants);
    }
```

✅ Test Scenario — Authorized User
1. Create a new user call owner2 
2. Login with admin and assign owner2 with role `owner`.
3. Login with owner2
4. Create at least 2 restaurants.
5. Call:

```json
GET /api/restaurants
```

Expected Result:

✅ 200 OK

---

❌ Test Scenario — Unauthorized User
1.	Login with a user who created fewer than 2 restaurants.
2.	Call the same endpoint.

Expected Result:
⛔ 403 Forbidden






