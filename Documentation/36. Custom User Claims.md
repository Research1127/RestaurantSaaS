# Custom User Claims
Custom claims are added to include additional user information inside the authentication token.

This allows the application to perform authorization checks without querying the database on every request, improving performance and scalability.

---

## Authentication Flow with Custom Claims

1.	User logs in via Identity endpoint
2.	ASP.NET Identity validates credentials
3.	RestaurantsUserClaimsPrincipalFactory is invoked
4.	Custom claims are added to the ClaimsPrincipal
5.	Claims are embedded inside the JWT token
6.	Token is sent with each request
7.	Controllers can access claims via User.Claims

## ⚠️ Important Consideration

Claims should only contain lightweight and infrequently changing data.

Avoid storing sensitive or large data inside claims because they are embedded within authentication tokens.

---

## Create Our Own Claim Principal
In our Infrastructure Module, we create a new file `Authorization/RestaurantsUserClaimsPrincipalFactory.cs`

### File: RestaurantsUserClaimsPrincipalFactory.cs

```csharp
namespace Restaurants.Infrastructure.Authorization;

public class RestaurantsUserClaimsPrincipalFactory(UserManager<User> userManager,
    RoleManager<IdentityRole> roleManager,
    IOptions<IdentityOptions> options)
    : UserClaimsPrincipalFactory<User,IdentityRole>(userManager,roleManager, options)
{
    public override async Task<ClaimsPrincipal> CreateAsync(User user)
    {
        var id = await GenerateClaimsAsync(user);

        if (user.Nationality != null)
        {
            id.AddClaim(new Claim("Nationality", user.Nationality));
        }

        if (user.DateOfBirth != null)
        {
            id.AddClaim(new Claim("DateOfBirth", user.DateOfBirth.Value.ToString("yyyy-MM-dd")));
        }
        
        return new ClaimsPrincipal(id);
    }
}
```
---

## Register Our Own ClaimPrincipal

In our Infrastructure Module, open `Extensions/ServiceCollectionExtensions.cs` file

### File: ServiceCollectionExtensions.cs

```csharp
services.AddIdentityApiEndpoints<User>()
        .AddRoles<IdentityRole>()
        .AddClaimsPrincipalFactory<RestaurantsUserClaimsPrincipalFactory>()
        .AddEntityFrameworkStores<RestaurantsDbContext>();
```


---

## How to Test (Swagger or Restaurants.Api.http)

Noted that only `testuser2@gmail.com` have `DateOfBirth` and `Nationality` value in our database

We put the breakpoint in our RestaurantsController for `GET` Endpoint which is `api/restaurants` because we want to test it.

We run the application in `Swagger` or go to our `Restaurants.Api.http`, then we login using `user = testuser2@gmail.com` and get the bearer token.

### Swagger Test
After that, we put the token in button `Authorize` in `Swagger`.

Then, we open our `GET` Endpoint for `api/restaurants` and we will automatically go to our breakpoint earlie

Check at variables > User > Claims > Results

We can see our DateOfBirth and Nationality claims are there already

### Restaurants.Api.http
```yaml
@Restaurants_Api_HostAddress = http://localhost:5204

@token = CfDJ8NWx4kvxRyZKrLy7i82zb4GsdCO46JaC7YJfLerYpiZvjmSzDV920OAHk5x6k_tKatSoR0phyM3BL-oG2oT93zJmaUJKwxwxjCBLTWNFYV1prZD5_74L-hV5Q0fTME7rR-EpYyITfiT3PZgsF2KosGKXcW2sF7f_yzu2s5OUDIO9vnr4g4UEByc7DYp_3fD7muT06vlo-NFgMq65g5IWvmbGGUX2nXvoxF9zbo4v0-_o4_-y-LknpowKORRt9u3Vvn6pe7K_7d6FvL0roUQ-X8624OL6FFok9Jr7u2WczuPs_a-XIzuahhO7TyyoVt95C2F084wHdzLcNzyV884kSJL9SW5kvREmOWX1ONe6OTc85XDHdSXPHqjJyKb9XMRZ1i3b1hvRlV3rfo6PVL_OKo9-hHX8zPCLSUVZENotEJfFFtSjF16sFpzftEYEEPh8QYzzVmUi8zlzgaAvwDdS-xiLF3hqeSN6bbnMN-IyA3C7flgA0x8x9ZMUSucK-Wx3LyaLeL8FZejgQeIwnVUVJtgkNKKGNrs2YK4ZI_gzLWHFiNOmXPSgzF-TiSB6cVRPRnK9IwYSoV1pSaAYSKlnSilDYhhv1VIjWTFMI4kfJBvc_9_8uSKP7Qe11ZBY3ZWP7FWL-v-17xRbgxvPorJWWpLAtAoHf-9-QhbqcBaVhcfoemX8NsqsFCv3LDrtt1OAZcIZH65OQYgRMKq6BwJA6FpLORXsilsBlRBPr_5uPmUjyHCstEEE4Jw1xuVShdG0PbW3KseVOuT754kVU8zYIEvAi4tn60qYffkvLegYfAXZ


###
GET {{Restaurants_Api_HostAddress}}/api/restaurants
Authorization: Bearer {{token}}
Accept: application/json

POST {{Restaurants_Api_HostAddress}}/api/identity/login
Content-Type: application/json

{
"email" : "testuser2@gmail.com",
"password" : "Password1!"
}
```
`The Flow`

**Run login** > **Get the token** > **Enter token to @token** > **Run GET api/restaurants endpoint**

---

Users without Nationality or DateOfBirth values in the database will not receive these claims, as they are conditionally added during ClaimsPrincipal creation.

