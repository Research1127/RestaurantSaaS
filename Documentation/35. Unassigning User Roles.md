# Unassigning User Roles

This endpoint allows administrators to remove a role assigned to a specific user.

Only users with the `Admin` role are authorized to perform this action.

---

## Create UnassignUserRole Method In IdentityController.cs

### IdentityController.cs

```csharp
[HttpDelete("userRole")]
[Authorize (Roles = UserRoles.Admin) ]
public async Task<IActionResult> UnassignUserRole(UnassignUserRoleCommand command)
{
    await mediator.Send(command);
    return NoContent();
}
```
---

## Create Command File To Unassign User Role

### File: UnassignUserRoleCommand.cs
```csharp
namespace Restaurants.Application.Users.Commands.UnassignUserRole;

public class UnassignUserRoleCommand : IRequest
{
    public string UserEmail { get; set; } = default!;
    public string RoleName { get; set; } = default!;
}
```
---

## Create Command Handler File To Unassign User Role

### File: UnassignUserRoleCommandHandler.cs

```csharp
namespace Restaurants.Application.Users.Commands.UnassignUserRole;

public class UnassignUserRoleCommandHandler(ILogger<UnassignUserRoleCommandHandler> logger,
    UserManager<User> userManager,
    RoleManager<IdentityRole> roleManager) : IRequestHandler<UnassignUserRoleCommand>
{
    public async Task Handle(UnassignUserRoleCommand request, CancellationToken cancellationToken)
    {
        logger.LogInformation("Unassigning user role: {@Role} from the user that has email: {@Email}", request.RoleName,request.UserEmail);
        var user = await userManager.FindByEmailAsync(request.UserEmail)
            ?? throw new NotFoundException(nameof(User), request.UserEmail);
        
        var role = await roleManager.FindByNameAsync(request.RoleName)
            ?? throw new NotFoundException(nameof(IdentityRole), request.RoleName);
        
        if (!await userManager.IsInRoleAsync(user, role.Name!))
            throw new InvalidOperationException($"User does not have role '{role.Name}'.");
        
        var result = await userManager.RemoveFromRoleAsync(user, role.Name!);

        if (!result.Succeeded)
        {
            var errors = string.Join(", ", result.Errors.Select(e => e.Description));
            throw new InvalidOperationException($"Failed to remove role: {errors}");
        }
        
    }
}
```

Added `IsInRole` checking and user `RemoveFromRoleAsync` method

---

## How to test

We run the application, then we login using `user = Admin` and get the bearer token.

After that, we put the token in button `Authorize` in swagger.

Then, we open our `DELETE` Endpoint for `api/identity/userRole` and unassign roles to specific user email

Note that we have 3 scenario which is:
- Admin user unassign correct role
- Admin user unassign role that not bind with the user
- Not an admin user try to unassign user role

---

## Console Log:

### Result Succeed
```shell
[03:02:2026 08:56:11 INF] Executing action method Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api) - Validation state: Valid
[03:02:2026 08:56:11 INF] Unassigning user role: {"UserEmail": "user@gmail.com", "RoleName": "owner", "$type": "UnassignUserRoleCommand"}
[03:02:2026 08:56:11 INF] Executed DbCommand (16ms) [Parameters=[@__normalizedEmail_0='?'], CommandType='Text', CommandTimeout='30']
... more code
... more code
... more code
[03:02:2026 08:56:11 INF] Executed action method Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api), returned result Microsoft.AspNetCore.Mvc.NoContentResult in 267.602ms.
[03:02:2026 08:56:11 INF] Executing StatusCodeResult, setting HTTP status code 204
[03:02:2026 08:56:11 INF] Executed action Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api) in 282.1505ms
[03:02:2026 08:56:11 INF] Executed endpoint 'Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api)'
[03:02:2026 08:56:11 INF] Request finished HTTP/1.1 DELETE http://localhost:5204/api/identity/userRole - 204 null null 311.3767ms

```
Can check in AspNetUserRoles table, the row will decrease because we delete the role for particular user
---

### Error Result

If Admin want to unassign user role that doesn't belong to that user

```shell
[03:02:2026 08:54:47 INF] Executed action Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api) in 161.2103ms
[03:02:2026 08:54:47 INF] Executed endpoint 'Restaurants.Api.Controllers.IdentityController.UnassignUserRole (Restaurants.Api)'
[03:02:2026 08:54:47 ERR] User does not have role 'Admin'.
System.InvalidOperationException: User does not have role 'Admin'.
```
---

If Non Admin user try to unassign role:

```shell
[03:02:2026 09:06:05 INF] Authorization failed. These requirements were not met:
RolesAuthorizationRequirement:User.IsInRole must be true for one of the following roles: (Admin)
[03:02:2026 09:06:05 INF] AuthenticationScheme: Identity.Bearer was forbidden.
```

